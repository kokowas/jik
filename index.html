<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ© - ÿßÿ≥ÿ™ŸÖÿßÿπ ŸàŸÇÿ±ÿßÿ°ÿ©</title>
    <style>
        @font-face { font-family: 'HafsFont'; src: url('conv_original-hafs.otf') format('opentype'); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'HafsFont', 'Amiri', Arial, sans-serif; direction: rtl; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; -webkit-tap-highlight-color: transparent; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .page-content-wrapper { width: 100%; max-width: 900px; position: relative; z-index: 1; }
        h1.surah-title { font-size: 2.5em; color: white; margin-top: 15px; margin-bottom: 25px; text-align: center; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        #modeSelector, #listenModeUI, #readModeUI, #sentence { background: rgba(255, 255, 255, 0.92); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        #modeSelector { display: flex; justify-content: center; gap: 15px; padding: 25px; }
        .mode-select-button { color: white; border: none; padding: 12px 25px; border-radius: 50px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); min-width: 140px; text-align: center; }
        #btnSelectListen { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        #btnSelectRead { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .mode-select-button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25); }
        .mode-select-button.active { background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%) !important; box-shadow: inset 0 3px 7px rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.2); transform: translateY(1px); }
        
        #listenModeUI .reader-select-group { margin-bottom: 15px; text-align: right; }
        #listenModeUI label { font-size: 1em; font-family: Arial, sans-serif; margin-bottom: 5px; display: block; color: #555; }
        #listenModeUI select { font-size: 1em; font-family: Arial, sans-serif; padding: 10px; width:100%; border-radius: 8px; border: 1px solid #ddd; background-color: white; }
        
        .preroll-title-display { 
            text-align: center; margin-bottom: 10px; padding-bottom: 10px; 
            font-size: 1.1em; color: #444;
        }
        .preroll-words-container { 
             text-align: center; margin-bottom: 20px; padding-bottom: 15px; 
             border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        #sentence { font-size: 30px; line-height: 2.6; text-align: right; }

        #sentence .word-span {
            display: inline-block; padding: 2px 4px; margin: 0; 
            border-radius: 5px; vertical-align: baseline;
            transition: all 0.2s ease-in-out; cursor: default;
        }

        .word-container { 
            position: relative; display: inline-block; 
            margin: 0 2px; vertical-align: baseline; 
            padding-top: 1.5em; 
        }
        .listen-mode-active #sentence .word-container {
            padding-top: 0 !important; 
        }
        
        .pronunciation-feedback { position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 1em; line-height: 1; visibility: hidden; font-family: Arial, sans-serif; z-index: 10; }
        .pronunciation-feedback.correct { color: green; visibility: visible; }
        .pronunciation-feedback.incorrect { color: red; visibility: visible; }

        .ayah-number { color: #667eea; font-size: 0.75em; margin: 0 5px; display: inline; }

        /* Listen Mode Specific Styles */
        .listen-mode-active #sentence .word-span.highlight-active-word { 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important; 
            color: #fff !important; 
            transform: scale(1.05); 
            box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3); 
        }
        .listen-mode-active #sentence .word-span.processed-word { 
            background: rgba(79, 172, 254, 0.15) !important; 
            color: #333 !important; 
            transform: none; 
        }
        /* Ensure visibility for listen mode elements that get styled */
        .listen-mode-active #sentence .word-span.highlight-active-word,
        .listen-mode-active #sentence .word-span.processed-word,
        .listen-mode-active #sentence .preroll-title-display,
        .listen-mode-active #sentence .ayah-number {
             visibility: visible !important;
        }


        /* Read Mode General Word Style (Default Visible Appearance) */
        .read-mode-active #sentence .word-span { 
            background-color: #f0f0f0; 
            color: #333; 
            transform: none;
            box-shadow: none;
            visibility: visible !important; 
        }
        .read-mode-active #sentence .preroll-title-display,
        .read-mode-active #sentence .ayah-number {
            visibility: visible !important;
        }

        /* Read Mode Specific Highlights */
        .read-mode-active #sentence .word-span.highlight-active-word { 
            background: linear-gradient(135deg, #ffda79 0%, #ffb142 100%) !important;
            color: #533f00 !important;
            transform: scale(1.05); 
            box-shadow: 0 2px 10px rgba(255, 177, 66, 0.4);
        }
        .read-mode-active #sentence .word-span.processed-word.correct-pronunciation { 
            background: rgba(67, 233, 123, 0.25) !important; 
            color: #1d7c3d !important; 
        }
        .read-mode-active #sentence .word-span.incorrect-pronunciation { 
            background: #ffdddd !important; 
            color: #a94442 !important; 
            box-shadow: 0 0 5px 2px rgba(255, 0, 0, 0.5) !important; 
        }

        .controls { margin-top: 15px; margin-bottom: 10px; display: flex; justify-content: center; gap:15px; }
        .controls button { border: none; padding: 12px 22px; border-radius: 50px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); min-width: 130px; text-align:center; color: white; }
        #listenControls button, #readControls button:not(#resetButtonRead) { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #readControls #resetButtonRead { background: linear-gradient(135deg, #868e96 0%, #595f65 100%); }
        .controls button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .controls button:active { transform: translateY(0px); }
        #readControls #speechButtonRead.listening { background: linear-gradient(135deg, #ff6b6b 0%, #f06595 100%) !important; animation: none !important; }
        #listenControls #playPauseButtonListen { font-size: 1.3em; padding: 10px 20px; }
        #speechStatusRead { font-size: 1.2em; color: #000000; background: rgba(255, 255, 255, 0.7); padding: 12px 20px; border-radius: 25px; min-height: 2.5em; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; line-height: 1.4; text-align: center; }
        #audioPlayerListen { display: none; }
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; opacity: 0; z-index: 1000; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
        .btn-pulsing { animation: pulse-glow-red 1.5s infinite alternate; }
        @keyframes pulse-glow-red { 0% { box-shadow: 0 6px 20px rgba(0,0,0,0.15), 0 0 0 0px rgba(255,0,0,0.7); } 100% { box-shadow: 0 6px 25px rgba(0,0,0,0.25), 0 0 0 12px rgba(255,0,0,0); } }
        @media (max-width: 768px) { body { padding: 15px; } .page-content-wrapper { padding: 0; } h1.surah-title { font-size: 2em; margin-bottom: 20px; } #modeSelector, #listenModeUI, #readModeUI, #sentence { padding: 15px; border-radius:12px; } #modeSelector { flex-direction: column; gap: 10px; padding: 20px; } .mode-select-button { font-size: 1.1em; padding: 12px 20px; width: 100%; max-width: 280px; margin: 0 auto; } .controls button { font-size: 1em; padding: 10px 18px; min-width: 110px; } #listenControls #playPauseButtonListen { font-size: 1.2em; } #sentence { font-size: 26px; line-height: 2.6; } .ayah-number { font-size: 0.7em; } #speechStatusRead {font-size: 1.1em;} }
        @media (max-width: 480px) { body { padding: 10px; } h1.surah-title { font-size: 1.7em; } #modeSelector, #listenModeUI, #readModeUI, #sentence { padding: 12px; border-radius:10px;} .mode-select-button { font-size: 1em; padding: 10px 15px; } .controls button { font-size: 0.9em; padding: 8px 15px; min-width: auto; } #listenControls #playPauseButtonListen { font-size: 1.1em; } #sentence { font-size: 22px; line-height: 2.3; } .ayah-number { font-size: 0.65em; } #speechStatusRead { font-size: 1em; padding: 10px 15px; } }
    </style>
</head>
<body>
 <div class="page-content-wrapper">
    <h1 class="surah-title">ÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©</h1>
    <div id="modeSelector">
        <button id="btnSelectListen" class="mode-select-button">üéµ ÿßÿ≥ŸÖÿπ</button>
        <button id="btnSelectRead" class="mode-select-button">üìñ ÿßŸÇÿ±ÿ£</button>
    </div>
    <div id="listenModeUI" style="display: none;">
        <div class="reader-select-group"><label for="readerSelect">ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿßÿ±ÿ¶:</label><select id="readerSelect"></select></div>
        <audio id="audioPlayerListen"></audio>
        <div class="controls" id="listenControls"><button id="playPauseButtonListen" class="btn-pulsing">‚ñ∂Ô∏è</button></div>
    </div>
    <div id="readModeUI" style="display: none;">
        <div id="speechStatusRead">ÿßÿ∂ÿ∫ÿ∑ "ÿßÿ®ÿØÿ£ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©" ŸàÿßŸÇÿ±ÿ£</div>
        <div class="controls" id="readControls">
            <button id="speechButtonRead" class="btn-pulsing">üé§ ÿßÿ®ÿØÿ£ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©</button>
            <button id="resetButtonRead">üîÑ ÿ•ÿπÿßÿØÿ©</button>
        </div>
    </div>
    <div id="sentence" style="display: none;"></div>
 </div>
<script>
    const SCRIPT_READERS_DATA = [
    {
        "name": "Default Reader",
        "audioFile": "099.mp3",
        "prerollTitle": "",
        "prerollTimings": [
            {
                "type": "word",
                "text": "ÿ®Ÿêÿ≥ŸíŸÖŸê",
                "time": "0.3"
            },
            {
                "type": "word",
                "text": "ÿßŸÑŸÑŸëŸéŸáŸê",
                "time": "0.8"
            },
            {
                "type": "word",
                "text": "ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸê",
                "time": "1.5"
            },
            {
                "type": "word",
                "text": "ÿßŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê",
                "time": "2.2"
            }
        ],
        "ayatTimings": [
            {
                "type": "word",
                "text": "ÿ•Ÿêÿ∞Ÿéÿß",
                "time": "6.85"
            },
            {
                "type": "word",
                "text": "ÿ≤ŸèŸÑŸíÿ≤ŸêŸÑŸéÿ™Ÿê",
                "time": "7.40"
            },
            {
                "type": "word",
                "text": "ÿßŸÑŸíÿ£Ÿéÿ±Ÿíÿ∂Ÿè",
                "time": "8.25"
            },
            {
                "type": "word",
                "text": "ÿ≤ŸêŸÑŸíÿ≤ŸéÿßŸÑŸéŸáŸéÿß",
                "time": "9.31"
            },
            {
                "type": "ayah",
                "text": "€ùŸ°"
            },
            {
                "type": "word",
                "text": "ŸàŸéÿ£ŸéÿÆŸíÿ±Ÿéÿ¨Ÿéÿ™Ÿê",
                "time": "11.92"
            },
            {
                "type": "word",
                "text": "ÿßŸÑŸíÿ£Ÿéÿ±Ÿíÿ∂Ÿè",
                "time": "12.97"
            },
            {
                "type": "word",
                "text": "ÿ£Ÿéÿ´ŸíŸÇŸéÿßŸÑŸéŸáŸéÿß",
                "time": "13.94"
            },
            {
                "type": "ayah",
                "text": "€ùŸ¢"
            },
            {
                "type": "word",
                "text": "ŸàŸéŸÇŸéÿßŸÑŸé",
                "time": "16.66"
            },
            {
                "type": "word",
                "text": "ÿßŸÑŸíÿ•ŸêŸÜÿ≥ŸéÿßŸÜŸè",
                "time": "17.59"
            },
            {
                "type": "word",
                "text": "ŸÖŸéÿß",
                "time": "19.70"
            },
            {
                "type": "word",
                "text": "ŸÑŸéŸáŸéÿß",
                "time": "20.24"
            },
            {
                "type": "ayah",
                "text": "€ùŸ£"
            },
            {
                "type": "word",
                "text": "ŸäŸéŸàŸíŸÖŸéÿ¶Ÿêÿ∞Ÿç",
                "time": "22.08"
            },
            {
                "type": "word",
                "text": "ÿ™Ÿèÿ≠ŸéÿØŸëŸêÿ´Ÿè",
                "time": "23.80"
            },
            {
                "type": "word",
                "text": "ÿ£ŸéÿÆŸíÿ®Ÿéÿßÿ±ŸéŸáŸéÿß",
                "time": "25.10"
            },
            {
                "type": "ayah",
                "text": "€ùŸ§"
            },
            {
                "type": "word",
                "text": "ÿ®Ÿêÿ£ŸéŸÜŸëŸé",
                "time": "27.78"
            },
            {
                "type": "word",
                "text": "ÿ±Ÿéÿ®ŸëŸéŸÉŸé",
                "time": "29.22"
            },
            {
                "type": "word",
                "text": "ÿ£ŸéŸàŸíÿ≠ŸéŸâŸ∞",
                "time": "30.23"
            },
            {
                "type": "word",
                "text": "ŸÑŸéŸáŸéÿß",
                "time": "31.12"
            },
            {
                "type": "ayah",
                "text": "€ùŸ•"
            },
            {
                "type": "word",
                "text": "ŸäŸéŸàŸíŸÖŸéÿ¶Ÿêÿ∞Ÿç",
                "time": "32.81"
            },
            {
                "type": "word",
                "text": "ŸäŸéÿµŸíÿØŸèÿ±Ÿè",
                "time": "34.55"
            },
            {
                "type": "word",
                "text": "ÿßŸÑŸÜŸëŸéÿßÿ≥Ÿè",
                "time": "35.68"
            },
            {
                "type": "word",
                "text": "ÿ£Ÿéÿ¥Ÿíÿ™Ÿéÿßÿ™Ÿãÿß",
                "time": "37.24"
            },
            {
                "type": "word",
                "text": "ŸÑŸëŸêŸäŸèÿ±ŸéŸàŸíÿß",
                "time": "38.64"
            },
            {
                "type": "word",
                "text": "ÿ£ŸéÿπŸíŸÖŸéÿßŸÑŸéŸáŸèŸÖŸí",
                "time": "39.68"
            },
            {
                "type": "ayah",
                "text": "€ùŸ¶"
            },
            {
                "type": "word",
                "text": "ŸÅŸéŸÖŸéŸÜ",
                "time": "41.83"
            },
            {
                "type": "word",
                "text": "ŸäŸéÿπŸíŸÖŸéŸÑŸí",
                "time": "42.55"
            },
            {
                "type": "word",
                "text": "ŸÖŸêÿ´ŸíŸÇŸéÿßŸÑŸé",
                "time": "43.68"
            },
            {
                "type": "word",
                "text": "ÿ∞Ÿéÿ±ŸëŸéÿ©Ÿç",
                "time": "44.78"
            },
            {
                "type": "word",
                "text": "ÿÆŸéŸäŸíÿ±Ÿãÿß",
                "time": "46.02"
            },
            {
                "type": "word",
                "text": "ŸäŸéÿ±ŸéŸáŸè",
                "time": "47.70"
            },
            {
                "type": "ayah",
                "text": "€ùŸß"
            },
            {
                "type": "word",
                "text": "ŸàŸéŸÖŸéŸÜ",
                "time": "49.51"
            },
            {
                "type": "word",
                "text": "ŸäŸéÿπŸíŸÖŸéŸÑŸí",
                "time": "50.58"
            },
            {
                "type": "word",
                "text": "ŸÖŸêÿ´ŸíŸÇŸéÿßŸÑŸé",
                "time": "51.63"
            },
            {
                "type": "word",
                "text": "ÿ∞Ÿéÿ±ŸëŸéÿ©Ÿç",
                "time": "52.72"
            },
            {
                "type": "word",
                "text": "ÿ¥Ÿéÿ±ŸëŸãÿß",
                "time": "54.75"
            },
            {
                "type": "word",
                "text": "ŸäŸéÿ±ŸéŸáŸè",
                "time": "56.41"
            },
            {
                "type": "ayah",
                "text": "€ùŸ®"
            }
        ]
    }
];
    const btnSelectListen = document.getElementById('btnSelectListen');
    const btnSelectRead = document.getElementById('btnSelectRead');
    const listenModeUI = document.getElementById('listenModeUI');
    const readModeUI = document.getElementById('readModeUI');
    const sentenceContainerShared = document.getElementById('sentence');
    const readerSelect = document.getElementById('readerSelect');

    let listen_words = [], read_wordSpans = [];
    let currentActiveMode = null, currentReaderDataForListen = null; 

    SCRIPT_READERS_DATA.forEach((reader, index) => { const option = document.createElement('option'); option.value = index; option.textContent = reader.name; readerSelect.appendChild(option); });
    
    function generateSentenceSpans(readerData) {
        sentenceContainerShared.innerHTML = '';
        
        if (readerData.prerollTitle && readerData.prerollTitle.trim() !== '') {
            const prerollTitleDiv = document.createElement('div');
            prerollTitleDiv.classList.add('preroll-title-display');
            prerollTitleDiv.textContent = readerData.prerollTitle;
            sentenceContainerShared.appendChild(prerollTitleDiv);
        }

        const prerollWordsContainer = document.createElement('div');
        prerollWordsContainer.classList.add('preroll-words-container');
        let hasPrerollWords = false;

        if (readerData.prerollTimings && readerData.prerollTimings.length > 0) {
            readerData.prerollTimings.forEach(item => {
                if (item.type === 'word' && item.text.trim() !== '') {
                    hasPrerollWords = true;
                    const wordContainer = document.createElement('div');
                    wordContainer.classList.add('word-container');
                    const wordSpan = document.createElement('span');
                    wordSpan.classList.add('word-span');
                    wordSpan.textContent = item.text;
                    if (item.time) wordSpan.dataset.time = item.time;
                    const feedbackSpan = document.createElement('span');
                    feedbackSpan.classList.add('pronunciation-feedback');
                    wordContainer.appendChild(wordSpan);
                    wordContainer.appendChild(feedbackSpan);
                    prerollWordsContainer.appendChild(wordContainer);
                }
            });
        }
        if(hasPrerollWords) {
            sentenceContainerShared.appendChild(prerollWordsContainer);
        } else {
            prerollWordsContainer.style.display = 'none';
            const prerollTitleDiv = sentenceContainerShared.querySelector('.preroll-title-display');
            if (prerollTitleDiv) prerollTitleDiv.style.borderBottom = 'none';
        }

        let lineBuffer = []; 
        readerData.ayatTimings.forEach(item => {
            if (item.type === 'word') {
                const wordContainer = document.createElement('div');
                wordContainer.classList.add('word-container');
                const wordSpan = document.createElement('span');
                wordSpan.classList.add('word-span');
                wordSpan.textContent = item.text;
                if (item.time) wordSpan.dataset.time = item.time;
                const feedbackSpan = document.createElement('span');
                feedbackSpan.classList.add('pronunciation-feedback');
                wordContainer.appendChild(wordSpan);
                wordContainer.appendChild(feedbackSpan);
                lineBuffer.push(wordContainer);
            } else { 
                const ayahSpan = document.createElement('span');
                ayahSpan.textContent = item.text;
                ayahSpan.classList.add('ayah-number');
                lineBuffer.forEach(wc => sentenceContainerShared.appendChild(wc));
                sentenceContainerShared.appendChild(ayahSpan);
                lineBuffer = [];
            }
        });
        if (lineBuffer.length > 0) {
            lineBuffer.forEach(wc => sentenceContainerShared.appendChild(wc));
        }
        
        listen_words = Array.from(sentenceContainerShared.querySelectorAll(".word-span[data-time]"));
    }

    function resetAllWordStyles() {
        const interactiveSpans = Array.from(sentenceContainerShared.querySelectorAll('.word-container > .word-span'));
        interactiveSpans.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word', 'correct-pronunciation', 'incorrect-pronunciation');
            span.style.cursor = 'default';
            span.style.backgroundColor = ''; 
            span.style.color = ''; 
            span.style.transform = ''; 
            span.style.boxShadow = '';
            // Visibility is handled by the mode's init function
            span.style.visibility = 'hidden'; 
            const feedbackEl = span.parentElement.querySelector('.pronunciation-feedback');
            if (feedbackEl) { feedbackEl.textContent = ''; feedbackEl.className = 'pronunciation-feedback'; }
        });
        sentenceContainerShared.querySelectorAll('.ayah-number, .preroll-title-display').forEach(el => el.style.visibility = 'hidden');
    }

    // --- LISTEN MODE ---
    const listen_audioPlayer = document.getElementById("audioPlayerListen");
    const listen_playPauseButton = document.getElementById("playPauseButtonListen");
    let listen_isPaused = false, listen_audioWasEnded = false;
    function listen_resetHighlights() { 
        listen_words.forEach(word => {
            word.classList.remove("highlight-active-word", "processed-word"); 
        }); 
        listen_audioWasEnded = false; 
    }
    function listen_toggleAudio() { if (!currentReaderDataForListen) return; if (listen_audioWasEnded) { listen_resetHighlights(); listen_audioPlayer.currentTime = 0; listen_playPauseButton.classList.add('btn-pulsing'); } if (listen_audioPlayer.paused || listen_audioPlayer.ended) { if (listen_audioPlayer.ended) { listen_audioPlayer.currentTime = 0; listen_resetHighlights(); } listen_audioPlayer.play().catch(e => console.error("Audio play error:", e)); listen_isPaused = false; listen_playPauseButton.textContent = "‚è∏Ô∏è"; listen_playPauseButton.classList.remove('btn-pulsing'); } else { listen_audioPlayer.pause(); listen_isPaused = true; listen_playPauseButton.textContent = "‚ñ∂Ô∏è"; if (!listen_audioWasEnded) listen_playPauseButton.classList.add('btn-pulsing'); } }
    function listen_highlightWords() { if (listen_isPaused || listen_audioWasEnded || !currentReaderDataForListen) return; const currentTime = listen_audioPlayer.currentTime; listen_words.forEach((word, index) => { let wordTime = parseFloat(word.dataset.time); let endTime = Infinity; for (let i = index + 1; i < listen_words.length; i++) { if (listen_words[i].hasAttribute('data-time')) { endTime = parseFloat(listen_words[i].dataset.time); break; } } if (endTime === Infinity) endTime = listen_audioPlayer.duration && !isNaN(listen_audioPlayer.duration) ? listen_audioPlayer.duration : wordTime + 1.0; if (currentTime >= wordTime && currentTime < endTime) { word.classList.add("highlight-active-word"); word.classList.remove("processed-word"); } else { word.classList.remove("highlight-active-word"); if (currentTime >= endTime && wordTime < currentTime) { word.classList.add("processed-word"); } else if (currentTime < wordTime) { word.classList.remove("processed-word"); } } }); if (!listen_audioPlayer.ended && listen_audioPlayer.currentTime >= listen_audioPlayer.duration - 0.1 && listen_audioPlayer.duration > 0) { listen_playPauseButton.textContent = "üîÑ"; listen_audioWasEnded = true; listen_words.forEach(w => { if(w.hasAttribute('data-time') && parseFloat(w.dataset.time) <= listen_audioPlayer.currentTime) { w.classList.add('processed-word'); w.classList.remove('highlight-active-word'); } }); listen_playPauseButton.classList.add('btn-pulsing'); } }
    function setupListenModeForReader(readerIndex) { 
        currentReaderDataForListen = SCRIPT_READERS_DATA[readerIndex]; if (!currentReaderDataForListen) return; 
        listen_audioPlayer.src = currentReaderDataForListen.audioFile; listen_audioPlayer.pause(); listen_audioPlayer.currentTime = 0; 
        listen_isPaused = true; listen_audioWasEnded = false; listen_playPauseButton.textContent = "‚ñ∂Ô∏è"; listen_playPauseButton.classList.add('btn-pulsing'); 
        generateSentenceSpans(currentReaderDataForListen); 
        resetAllWordStyles();
        
        const allElementsToMakeVisible = sentenceContainerShared.querySelectorAll('.word-span, .ayah-number, .preroll-title-display');
        allElementsToMakeVisible.forEach(el => el.style.visibility = 'visible');
        
        listen_words.forEach(word => { 
            word.style.cursor = 'pointer';
            word.onclick = function() { if (listen_audioWasEnded) { listen_resetHighlights(); listen_audioWasEnded = false; listen_playPauseButton.classList.add('btn-pulsing');} listen_audioPlayer.currentTime = parseFloat(this.dataset.time); listen_highlightWords(); if (listen_audioPlayer.paused || listen_audioPlayer.ended) { listen_audioPlayer.play().catch(e => console.error("Audio play error:", e)); listen_isPaused = false; listen_playPauseButton.textContent = "‚è∏Ô∏è"; listen_playPauseButton.classList.remove('btn-pulsing'); } }; 
        }); 
    }
    function initListenMode() { 
        listenModeUI.style.display = 'block'; sentenceContainerShared.style.display = 'block'; 
        sentenceContainerShared.classList.remove('read-mode-active'); 
        sentenceContainerShared.classList.add('listen-mode-active');
        const readerSelectGroup = document.querySelector('#listenModeUI .reader-select-group'); 
        if (SCRIPT_READERS_DATA.length <= 1) { if (readerSelectGroup) readerSelectGroup.style.display = 'none'; if (SCRIPT_READERS_DATA.length === 1) setupListenModeForReader(0); else sentenceContainerShared.innerHTML = "<p>No reader data.</p>"; } 
        else { if (readerSelectGroup) readerSelectGroup.style.display = 'block'; readerSelect.value = "0"; setupListenModeForReader(0); } 
        listen_playPauseButton.onclick = listen_toggleAudio; listen_audioPlayer.ontimeupdate = listen_highlightWords; 
        listen_audioPlayer.onended = () => { listen_playPauseButton.textContent = "üîÑ"; listen_isPaused = true; listen_audioWasEnded = true; listen_words.forEach(w => { if (w.classList.contains('highlight-active-word')) {w.classList.remove('highlight-active-word'); w.classList.add('processed-word');} else if (w.hasAttribute('data-time') && parseFloat(w.dataset.time) <= listen_audioPlayer.currentTime) {w.classList.add('processed-word');}}); listen_playPauseButton.classList.add('btn-pulsing'); }; 
        listen_audioPlayer.onplay = () => { listen_isPaused = false; listen_highlightWords(); listen_playPauseButton.classList.remove('btn-pulsing'); }; 
        listen_audioPlayer.onpause = () => { if(!listen_audioWasEnded && listen_isPaused) listen_playPauseButton.classList.add('btn-pulsing'); };
        listen_audioPlayer.onseeked = listen_highlightWords; readerSelect.onchange = (e) => setupListenModeForReader(parseInt(e.target.value)); 
    }
    function deactivateListenMode() { 
        if (listen_audioPlayer && !listen_audioPlayer.paused) listen_audioPlayer.pause(); 
        listen_playPauseButton.textContent = "‚ñ∂Ô∏è"; listen_playPauseButton.classList.remove('btn-pulsing'); 
        listenModeUI.style.display = 'none'; 
        sentenceContainerShared.classList.remove('listen-mode-active');
        listen_playPauseButton.onclick = null; listen_audioPlayer.ontimeupdate = null; listen_audioPlayer.onended = null; listen_audioPlayer.onplay = null; listen_audioPlayer.onseeked = null; listen_audioPlayer.onpause = null; readerSelect.onchange = null; 
        
        const allTextElements = sentenceContainerShared.querySelectorAll('.word-span, .preroll-title-display, .ayah-number');
        allTextElements.forEach(el => el.style.visibility = 'hidden');
        if (Array.isArray(listen_words)) listen_words.forEach(word => word.onclick = null);
        currentReaderDataForListen = null; 
    }

    // --- READ MODE ---
    const read_speechButton = document.getElementById("speechButtonRead");
    const read_speechStatus = document.getElementById("speechStatusRead");
    const read_resetButton = document.getElementById("resetButtonRead");
    let read_currentWordIndex = 0, read_isRecognizing = false, read_accumulatedFinalTranscript = "";
    let read_shouldRestart = false, read_restartTimeout, read_silenceTimeout, read_recognition;
    let read_isManualStop = false; // Flag to indicate if stop was user-initiated

    function read_normalizeArabic(text) { if (!text) return ""; text = text.replace(/[\u064B-\u0652\u0670\u06D6-\u06ED]/g, ""); text = text.replace(/[ÿ•ÿ£ÿ¢Ÿ±Ÿ∞]/g, "ÿß"); text = text.replace(/ÿ©/g, "Ÿá"); text = text.replace(/Ÿâ/g, "Ÿä"); text = text.replace(/ÿ§/g, "Ÿà"); text = text.replace(/ÿ¶/g, "Ÿä"); text = text.replace(/\u0640/g, ""); return text.trim(); }
    function triggerConfettiEffect() { const confettiCount = 100; const confettiColors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800']; for (let i = 0; i < confettiCount; i++) { const confetti = document.createElement('div'); confetti.classList.add('confetti'); confetti.style.left = Math.random() * 100 + 'vw'; confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)]; confetti.style.animationDelay = Math.random() * 0.5 + 's'; confetti.style.width = (Math.random() * 8 + 5) + 'px'; confetti.style.height = confetti.style.width; confetti.style.transform = `translateY(-10vh) rotateZ(${Math.random() * 360}deg)`; document.body.appendChild(confetti); setTimeout(() => { if (confetti.parentNode) { confetti.parentNode.removeChild(confetti); } }, 3500); } }

    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognitionAPI) { 
        read_recognition = new SpeechRecognitionAPI(); read_recognition.continuous = true; read_recognition.interimResults = true; read_recognition.lang = 'ar-SA';
        read_recognition.onstart = () => { 
            read_isRecognizing = true; 
            read_accumulatedFinalTranscript = ""; 
            read_speechButton.textContent = "üî¥ ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÇÿ±ÿßÿ°ÿ©..."; 
            read_speechButton.classList.add('listening'); 
            read_speechButton.classList.remove('btn-pulsing'); 
            read_speechStatus.textContent = "ÿßŸÇÿ±ÿ£ ÿßŸÑÿ¢ŸÜ..."; 
            if (read_restartTimeout) clearTimeout(read_restartTimeout); 
            if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
            read_restartTimeout = null; 
            read_silenceTimeout = null; 
            read_isManualStop = false; // Reset manual stop flag
        };
        read_recognition.onend = () => { 
            read_isRecognizing = false; 
            if (read_restartTimeout) clearTimeout(read_restartTimeout); 
            if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
            read_restartTimeout = null; read_silenceTimeout = null; 
            
            // Only restart if it wasn't a manual stop and we are still supposed to be listening
            if (!read_isManualStop && read_shouldRestart && read_currentWordIndex < read_wordSpans.length) { 
                read_restartTimeout = setTimeout(() => { 
                    if (!read_isRecognizing && read_shouldRestart && read_currentWordIndex < read_wordSpans.length) { 
                        try { read_recognition.start(); } 
                        catch (e) { 
                            console.error("Error restarting recognition in onend:", e);
                            read_shouldRestart = false; read_updateUIForStopped(); 
                        } 
                    } 
                }, 300); // Increased delay
            } else { 
                read_updateUIForStopped(); 
            } 
        };
        function read_updateUIForStopped() { read_speechButton.textContent = "üé§ ÿßÿ®ÿØÿ£ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©"; read_speechButton.classList.remove('listening'); if (read_currentWordIndex < read_wordSpans.length) { read_speechButton.classList.add('btn-pulsing'); } else { read_speechButton.classList.remove('btn-pulsing'); } if (read_currentWordIndex < read_wordSpans.length && read_currentWordIndex > 0) { read_speechStatus.textContent = "ÿ™ŸàŸÇŸÅÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©. ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÖÿ™ÿßÿ®ÿπÿ©."; } else if (read_currentWordIndex === 0) { read_speechStatus.textContent = 'ÿßÿ∂ÿ∫ÿ∑ "ÿßÿ®ÿØÿ£ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©" ŸàÿßŸÇÿ±ÿ£'; } else if (read_currentWordIndex >= read_wordSpans.length) { /* Message set by onresult */ } }
        read_recognition.onerror = (event) => { 
            console.error("Speech recognition error:", event.error, event.message);
            let errorMsg = "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿπÿ±ŸÅ: " + event.error; 
            if (event.error === 'aborted' && read_shouldRestart) {
                 // If aborted but we want to restart, onend will handle it.
                return;
            }
            if (event.error === 'no-speech' && read_shouldRestart && read_currentWordIndex < read_wordSpans.length) { 
                read_speechStatus.textContent = "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ≥ŸÖÿßÿπ ÿ£Ÿä ŸÉŸÑÿßŸÖ. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
                // onend will be triggered after no-speech, and will attempt restart if read_shouldRestart is true
                return; 
            } 
            // For other errors, or if not supposed to restart, update UI and stop.
            if (!read_shouldRestart || (event.error !== 'no-speech' && event.error !== 'aborted')) { 
                read_speechStatus.textContent = errorMsg; 
                read_isRecognizing = false; // Ensure this is set
                read_shouldRestart = false; // Don't attempt restart for critical errors
                read_updateUIForStopped(); 
            } 
        };
        read_recognition.onresult = (event) => { 
            if (read_silenceTimeout) clearTimeout(read_silenceTimeout); read_silenceTimeout = null; 
            let interimTranscript = ''; 
            for (let i = event.resultIndex; i < event.results.length; ++i) { const transcriptPart = event.results[i][0].transcript; if (event.results[i].isFinal) read_accumulatedFinalTranscript += transcriptPart + " "; else interimTranscript += transcriptPart; } 
            if (interimTranscript && read_isRecognizing) { read_speechStatus.textContent = "ŸÑÿ≠ÿ∏ÿ©... " + interimTranscript; read_silenceTimeout = setTimeout(() => { if (read_isRecognizing && read_shouldRestart && read_currentWordIndex < read_wordSpans.length) read_speechStatus.textContent = "ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©..."; }, 3000); } 
            
            if (read_accumulatedFinalTranscript && read_currentWordIndex < read_wordSpans.length && read_isRecognizing) { 
                const wordsToProcess = read_accumulatedFinalTranscript.trim().split(" ").filter(w => w.length > 0); 
                read_accumulatedFinalTranscript = ""; 
                for (let spokenWord of wordsToProcess) { 
                    if (!read_isRecognizing || read_currentWordIndex >= read_wordSpans.length) break; 
                    const normalizedSpokenWord = read_normalizeArabic(spokenWord); 
                    if (!normalizedSpokenWord) continue; 
                    
                    const targetWordSpan = read_wordSpans[read_currentWordIndex];
                    if (!targetWordSpan || !targetWordSpan.parentElement || !targetWordSpan.parentElement.classList.contains('word-container')) continue;
                    const feedbackEl = targetWordSpan.parentElement.querySelector('.pronunciation-feedback');
                    const targetWordText = targetWordSpan.dataset.word;

                    if (targetWordText && normalizedSpokenWord === targetWordText) { // CORRECT
                        if (feedbackEl) { feedbackEl.textContent = '‚úî'; feedbackEl.className = 'pronunciation-feedback correct'; }
                        targetWordSpan.classList.remove('highlight-active-word', 'incorrect-pronunciation');
                        targetWordSpan.classList.add('processed-word', 'correct-pronunciation');
                        read_currentWordIndex++;
                        if (read_currentWordIndex < read_wordSpans.length) {
                            read_speechStatus.textContent = "ŸÖŸÖÿ™ÿßÿ≤! ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©...";
                            const nextWordSpan = read_wordSpans[read_currentWordIndex];
                            if (nextWordSpan) {
                                nextWordSpan.classList.add('highlight-active-word');
                                const nextFeedbackEl = nextWordSpan.parentElement.querySelector('.pronunciation-feedback');
                                if (nextFeedbackEl) { nextFeedbackEl.textContent = ''; nextFeedbackEl.className = 'pronunciation-feedback';}
                            }
                        }
                    } else if (targetWordText) { // INCORRECT
                        if (feedbackEl) { feedbackEl.textContent = '‚ùå'; feedbackEl.className = 'pronunciation-feedback incorrect';}
                        targetWordSpan.classList.remove('correct-pronunciation', 'processed-word');
                        targetWordSpan.classList.add('incorrect-pronunciation', 'highlight-active-word');
                        read_speechStatus.textContent = `ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ: "${targetWordSpan.textContent}"`;
                        // Don't stop recognition here. Let 'onend' handle restarts if the service stops.
                        break; 
                    }
                } 
                if (read_currentWordIndex >= read_wordSpans.length) { 
                    read_speechStatus.textContent = "üéâ ÿ£ÿ≠ÿ≥ŸÜÿ™! ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿßŸÑÿ≥Ÿàÿ±ÿ©. üéâ"; triggerConfettiEffect(); 
                    read_shouldRestart = false; // No more words to read
                    read_isManualStop = true; // Treat completion as a manual stop for restart logic
                    if (read_isRecognizing) read_recognition.stop(); else read_updateUIForStopped(); 
                    read_speechButton.classList.remove('btn-pulsing'); 
                } 
            } 
        };
    }
    
    function read_toggleSpeechRecognition() { 
        if (!SpeechRecognitionAPI) return; 
        if (read_isRecognizing) { // If currently recognizing, stop it.
            read_shouldRestart = false; // User clicked stop, so don't auto-restart.
            read_isManualStop = true;   // Mark as manual stop
            read_recognition.stop(); 
            // onend will call read_updateUIForStopped
        } else { // Not recognizing, so start it.
            if (read_currentWordIndex >= read_wordSpans.length) read_resetActivity(); 
            read_shouldRestart = true; 
            read_isManualStop = false;
            read_speechButton.classList.remove('btn-pulsing');
            try { 
                if (read_currentWordIndex < read_wordSpans.length) { 
                    const currentTargetSpan = read_wordSpans[read_currentWordIndex]; 
                    if (currentTargetSpan && !currentTargetSpan.classList.contains('processed-word') && !currentTargetSpan.classList.contains('highlight-active-word')) { 
                        currentTargetSpan.classList.add('highlight-active-word'); 
                        const feedbackEl = currentTargetSpan.parentElement.querySelector('.pronunciation-feedback');
                        if (feedbackEl) { feedbackEl.textContent = ''; feedbackEl.className = 'pronunciation-feedback';}
                    } 
                } 
                read_recognition.start(); 
            } catch (e) { 
                console.error("Error starting recognition in toggle:", e);
                read_shouldRestart = false; read_isRecognizing = false; read_updateUIForStopped(); 
            } 
        } 
    }
    function read_resetActivity() { 
        read_currentWordIndex = 0; read_accumulatedFinalTranscript = ""; 
        read_shouldRestart = false; // Reset this flag
        read_isManualStop = true;   // Resetting is like a manual stop

        if (read_isRecognizing) {
            read_recognition.stop(); // Stop if it's somehow still running
        }
        if (read_restartTimeout) clearTimeout(read_restartTimeout); 
        if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
        read_restartTimeout = null; read_silenceTimeout = null; 
        
        resetAllWordStyles(); 
        
        const allElementsInReadMode = sentenceContainerShared.querySelectorAll('.word-span, .preroll-title-display, .ayah-number');
        allElementsInReadMode.forEach(el => el.style.visibility = 'visible');

        if (read_wordSpans.length > 0) { 
            const firstWord = read_wordSpans[0]; 
            if (firstWord) { 
                firstWord.classList.add('highlight-active-word'); 
            } 
        } 
        read_speechStatus.textContent = 'ÿßÿ∂ÿ∫ÿ∑ "ÿßÿ®ÿØÿ£ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©" ŸàÿßŸÇÿ±ÿ£'; 
        read_updateUIForStopped(); // Ensure button state is correct
    }
    function initReadMode() { 
        readModeUI.style.display = 'block'; 
        sentenceContainerShared.style.display = 'block'; 
        sentenceContainerShared.classList.remove('listen-mode-active');
        sentenceContainerShared.classList.add('read-mode-active'); 
        read_speechButton.classList.add('btn-pulsing');
        
        if (SCRIPT_READERS_DATA.length > 0) {
            generateSentenceSpans(SCRIPT_READERS_DATA[0]); 
            read_wordSpans = Array.from(sentenceContainerShared.querySelectorAll('.word-container > .word-span'));
        } else { 
            sentenceContainerShared.innerHTML = "<p>No text configured.</p>"; 
            read_wordSpans = []; 
        } 

        const allElementsInReadMode = sentenceContainerShared.querySelectorAll('.word-span, .preroll-title-display, .ayah-number');
        allElementsInReadMode.forEach(el => el.style.visibility = 'visible');

        if (!SpeechRecognitionAPI) { read_speechButton.disabled = true; read_speechButton.textContent = "ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ"; read_resetButton.disabled = true; read_speechStatus.textContent = "ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ."; return; } 
        else { read_speechButton.disabled = false; read_resetButton.disabled = false; } 
        
        read_wordSpans.forEach(span => { 
            span.dataset.word = read_normalizeArabic(span.textContent); 
        }); 
        read_resetActivity(); 
        read_speechButton.onclick = read_toggleSpeechRecognition; 
        read_resetButton.onclick = read_resetActivity; 
    }
    function deactivateReadMode() { 
        read_shouldRestart = false; // Explicitly prevent restarts when deactivating
        read_isManualStop = true;
        if (SpeechRecognitionAPI && read_recognition && read_isRecognizing) { 
            read_recognition.stop(); 
        } 
        if (read_restartTimeout) clearTimeout(read_restartTimeout); 
        if (read_silenceTimeout) clearTimeout(read_silenceTimeout); 
        read_restartTimeout = null; read_silenceTimeout = null; 

        readModeUI.style.display = 'none'; 
        sentenceContainerShared.classList.remove('read-mode-active');
        
        const allTextElements = sentenceContainerShared.querySelectorAll('.word-span, .preroll-title-display, .ayah-number');
        allTextElements.forEach(el => el.style.visibility = 'hidden');

        read_speechButton.onclick = null; read_resetButton.onclick = null; 
        read_speechButton.classList.remove('btn-pulsing'); 
    }

    function switchToMode(mode) { 
        if (currentActiveMode === 'listen') deactivateListenMode(); 
        else if (currentActiveMode === 'read') deactivateReadMode(); 
        
        btnSelectListen.classList.remove('active'); 
        btnSelectRead.classList.remove('active'); 
        
        sentenceContainerShared.innerHTML = ''; 

        if (mode === 'listen') { 
            initListenMode(); btnSelectListen.classList.add('active'); currentActiveMode = 'listen'; 
        } else if (mode === 'read') { 
            initReadMode(); btnSelectRead.classList.add('active'); currentActiveMode = 'read'; 
        } else { 
            listenModeUI.style.display = 'none'; readModeUI.style.display = 'none'; 
            if (sentenceContainerShared) {
                sentenceContainerShared.style.display = 'none';
                sentenceContainerShared.classList.remove('read-mode-active', 'listen-mode-active');
            }
            currentActiveMode = null; 
        } 
    }
    btnSelectListen.addEventListener('click', () => switchToMode('listen'));
    btnSelectRead.addEventListener('click', () => switchToMode('read'));
    
    if (SCRIPT_READERS_DATA && SCRIPT_READERS_DATA.length > 0) {
        switchToMode('listen'); 
    } else {
        sentenceContainerShared.innerHTML = '<p style="text-align:center; color:white;">No reader data available to display.</p>';
        sentenceContainerShared.style.display = 'block';
    }
</script>
</body>
</html>